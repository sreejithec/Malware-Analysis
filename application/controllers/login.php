<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
/**
 * Class that handles the login functionality
 * 
 * @package MalwareAnalysis
 * 
 *
 */
class Login extends QCERT_Controller {
	

	/**
	* Method that handles the user login
	* @access public
	*
	*/
	public function index()
	{   $this->load->library('form_validation');
		$this->load->library('encrypt');
		if($this->input->post('go') == 'Login'){
			
			$this->form_validation->set_error_delimiters('', '|');
			
			$this->form_validation->set_rules('email', 'Email', 'trim|required|xss_clean|valid_email|callback_validate');
			$this->form_validation->set_rules('password', 'Password', 'trim|required|xss_clean');
			if (!($this->form_validation->run() == FALSE)){
					redirect(base_url().'home');
			}else{
				$errors = explode('|',substr(validation_errors(),0,-2));
				FlashNotice::set_messages($errors, 'error');
			}

		}
		$this->loginrender('login');
	}
	
	
	/**
	 * A callback function for login form validation to validate the email/password combination
	 *
	 * @return bool
	 */
	public function validate(){
		$this->load->model('login_model');
		
		$email = $this->input->post('email');
		$pass = $this->input->post('password');
		
		if(!($admin = $this->login_model->validate($email, $pass))){
			$this->form_validation->set_message('validate', 'Email/Password is not valid');
			return FALSE;
		}else {
			// Set the admin session
			$this->session->set_userdata(
						array('id'=> $admin->id,
							  'name'=> $admin->name,
							  'email'=> $admin->email
					    ));
			return TRUE;
		}
		
	}

	
}
/* End of file index.php */
/* Location: ./application/controllers/admin/index.php */

?>