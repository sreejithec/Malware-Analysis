<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');
/**
 * Malware
 * 
 * Controller that handles all malware related operations like, saving the malware send by HomeyPot, submit them for analysis, poll for results,
 * save the reports etc.
 * 
 * 
 * 
 */
class Malware extends QCERT_Controller {
	
	CONST STATUS_NEW 		= 'NEW';
	CONST STATUS_SUBMITTED	= 'SUBM';
	CONST STATUS_DONE 		= 'DONE';
	
	private $_save_path;
	private $_file_param_name;
	
	/**
	 * __construct
	 * 
	 *
	 */
	public function __construct(){
		parent::__construct();
		$this->load->model('malware_model');
		
		$this->status_text = array(
								self::STATUS_NEW => 'New',
								self::STATUS_SUBMITTED => 'Submitted',
								self::STATUS_DONE => 'Done'
							 );
		
		$this->_save_path 		= 'analysis/source/';
		$this->_file_param_name = 'upfile';
	}

	
	public function listing($page=1){
		$data['status_text'] = $this->status_text;
		$page = ($page) ? (int)$page : 1;
		
		$this->malware_model->start  = $this->malware_model->limit = NULL;
		$this->paginate(count($this->malware_model->getCollection()), base_url().'malware/listing');
		
		$this->malware_model->start  = ((int)$this->uri->segment(PAGE_SEGMENT)) ? $this->uri->segment(PAGE_SEGMENT) : 0;
		$this->malware_model->limit = PER_PAGE;
		
		$data['collection'] = $this->malware_model->getCollection($page);
		$this->render('malware/listing',$data);
	}
	
	public function post_malware(){
		$data = array();
		$this->load->library('form_validation');
		
		if($this->input->post('go') == 'Submit'){
			$this->form_validation->set_error_delimiters('', '|');
			
			$this->form_validation->set_rules('email', 'Email', 'trim|required|xss_clean|valid_email');
			if (!($this->form_validation->run() == FALSE)){
				$this->load->helper('file');
				$sender_email = $this->input->post('email');

				if(!empty($_FILES[$this->_file_param_name]['tmp_name'])){
					$filename = $_FILES[$this->_file_param_name]['name'];
					// Check for duplicate file
					if(!($this->malware_model->is_duplicate($filename))){
						// Upload the file
						if($this->malware_model->do_upload($filename, $this->_save_path)){
							// Save the file data in database
							$ins = array('filename'=>$filename,
											'sender_email' => $sender_email,
											'size' => $_FILES[$this->_file_param_name]['size'],
											'received_date' => mktime(),
											'm_count' => 1,
											'commercial_status' => self::STATUS_NEW ,
											'zerowine_status' => self::STATUS_NEW,
									);
							$this->malware_model->insert($ins);

							// Now submit the files for analysis to both servers
							$this->analysis_submit($filename, array('email' => $sender_email));

							if($this->input->post('web') == 1){
								FlashNotice::add('File has been sent for analysis successfully. Please go to Malwares section for the details.', 'success');
							}
						}
					}
					else{
						// We have a duplicate. Just increment the m_count column by one.
						$this->malware_model->increment_m_count($filename);
						if($this->input->post('web') == 1){
							FlashNotice::add('We have this file already in our database.  Please search the Malwares section for the details.', 'info');
						}
					}
				}else{
					
					FlashNotice::add('The File field is required.', 'error');
				}
				
			}else{
				$errors = explode('|',substr(validation_errors(),0,-2));
				FlashNotice::set_messages($errors, 'error');
			}
		}

		$this->render('malware/post_malware', $data);
	}


	public function caught(){
		$this->load->helper('file');
		$sender_email = $this->input->post('email');
		
		if(!empty($_FILES[$this->_file_param_name]['tmp_name'])){
			$filename = $_FILES[$this->_file_param_name]['name'];
			// Check for duplicate file
			if(!($this->malware_model->is_duplicate($filename))){
				// Upload the file
				if($this->malware_model->do_upload($filename, $this->_save_path)){
					// Save the file data in database
					$ins = array('filename'=>$filename,
								 'sender_email' => $sender_email,
								 'size' => $_FILES[$this->_file_param_name]['size'],
								 'received_date' => mktime(),
								 'm_count' => 1,
								 'commercial_status' => self::STATUS_NEW ,
								 'zerowine_status' => self::STATUS_NEW,
							);
					$this->malware_model->insert($ins);
					
					// Now submit the files for analysis to both servers
					$this->analysis_submit($filename, array('email' => $sender_email));
				}
			}
			else{
				// We have a duplicate. Just increment the m_count column by one.
				$this->malware_model->increment_m_count($filename);
			}
			
		}
		
	}
	
	public function view_report($filename, $sandbox='commercial'){
		$data = array();
		$data['filename'] = $filename;
		$data['sandbox'] = $sandbox;
		
		$this->render('malware/view_report', $data);
	}
	
	public function analysis_submit($filename, $params){
		// Submit to commercial sandbox
		$response = $this->_analysis_submit_commercial($filename, $params);
		if($response){
			$this->malware_model->save_response('commercial', $filename, $response);
			$this->malware_model->update_status($filename, self::STATUS_SUBMITTED, 'commercial');
			$this->malware_model->add_queue($filename);
		}
		
		//Submit to zerowine sandbox
		$response = $this->_analysis_submit_zerowine($filename);
		if($response){
			$this->malware_model->save_response('zerowine', $filename, $response );
			$this->malware_model->update_status($filename, self::STATUS_DONE , 'zerowine');
		}
	}
	
	private function _analysis_submit_commercial($filename, $params){
		$response = '';
		$this->load->library('commercial', array('filename' => $filename));
		$response = $this->commercial->analysis_submit($this->_save_path.$filename, $params);
		return $response;
	}
	
	private function _analysis_submit_zerowine($filename){
		$response = '';
		$this->load->library('zerowine', array('filename' => $filename));
		$response = $this->zerowine->analysis_submit($this->_save_path.$filename);
		return $response;
	}
	
	public function get_analysis_content(){
		if($this->input->post('sandbox') == 'commercial'){
			$data = array();
			
			switch ($this->input->post('section')){
				case 'basic_info':
					$this->load->library('Commercial/basic_info',array('filename'=> $this->input->post('file')));
					if($this->basic_info->load_xml()){
						$data['basic_info'] = $this->basic_info->get_basic_info();
						$data['calltree'] = $this->basic_info->get_call_tree();
						$html = $this->load->view('commercial/basic_info', $data, TRUE);
					}else{
						$html = '<div class="info">Sorry dude, No data to display!</div>';
					}
					break;
					
				case 'file_info':
					$this->load->library('Commercial/file_info',array('filename'=> $this->input->post('file')));
					if($this->file_info->load_xml()){
						$data['file_info'] = $this->file_info->get_process_file_info();
						$html = $this->load->view('commercial/file_info', $data, TRUE);
					}
					else{
						$html = '<div class="info">Sorry dude, No data to display!</div>';
					}
					break;
					
				case 'registry_info':
					$this->load->library('Commercial/registry_info',array('filename'=> $this->input->post('file')));
					if($this->registry_info->load_xml()){
						$data['registry_info'] = $this->registry_info->get_process_reg_info();
						$html = $this->load->view('commercial/registry_info', $data, TRUE);
					}else{
						$html = '<div class="info">Sorry dude, No data to display!</div>';
					}
					break;
			
				case 'network_info':
					$this->load->library('Commercial/network_info',array('filename'=> $this->input->post('file')));
					if($this->network_info->load_xml()){
						$data['network_info'] = $this->network_info->get_network_info();
						$html = $this->load->view('commercial/network_info', $data, TRUE);
					}else{
						$html = '<div class="info">Sorry dude, No data to display!</div>';
					}
					break;

				case 'all_process_info':
					$this->load->library('Commercial/all_process_info',array('filename'=> $this->input->post('file')));
					if($this->all_process_info->load_xml()){
						$data['all_process_info'] = $this->all_process_info->get_all_info();
						$html = $this->load->view('commercial/all_process_info', $data, TRUE);
					}else{
						$html = '<div class="info">Sorry dude, No data to display!</div>';
					}
					break;
					
				case 'download_info':
					$download_info = $this->malware_model->get_commercial_report($this->input->post('file'));
					
					if(isset($download_info->commercial_analysis_report)){
						$info = array();
						$this->load->library('commercial');
						$server_url = $this->commercial->get_server_url();
						list($id,$filename, $filemd5,$xml,$cab,$pcap,$date_created,$dbt) = explode(',', $download_info->commercial_analysis_report);
						$info['xml_url'] = $server_url.$xml;
						$info['pcap_url'] = $server_url.$pcap;
						$info['cab_url']  = $server_url.$cab;
						$info['dbt']  = $dbt;
						$data['download_info'] = $info;
						$html = $this->load->view('commercial/download_info', $data, TRUE);
					}else {
						$html = '<div class="info">Sorry dude, No data to display!</div>';
					}
					break;
			}
			echo $html;
			exit(0);
		}
		
		if($this->input->post('sandbox') == 'zerowine'){
			$data = array();
			
			$this->load->library('zerowine', array('filename' => $this->input->post('file'), 
										     )
								);
			$current_folder = ($this->input->post('dir')) ? $this->input->post('dir') : '';
			if(! ($html = $this->zerowine->get_file_tree($current_folder))){
				$html = '<div class="info">Sorry dude, No data to display!</div>';
			}
			echo $html;
			exit(0);
			
			
		}
	}
	
	public function get_file(){
		$file = $this->input->get('file', TRUE);
		$type = $this->input->get('type', TRUE);
		$this->load->helper('file');
		
		if(file_exists($file)){
			if($type == 'content'){
				echo file_get_contents($file);
				exit;
			}else{
				$this->load->helper('download');
				force_download(basename($file), file_get_contents($file));
			}
		}
	}
	
	public function submit(){
		echo '
			<form enctype="multipart/form-data" method="POST" action="'.base_url().'malware/caught">
				<input type="text" name="email" value="" />
				<input type="file" name="upfile" /> <input type="submit" value="go" />
			</form>
		';
	}
	
	/**
	 * This will be executed by cron
	 *
	 */
	public function get_commercial_analysis_report(){
		$sub_malwares = $this->malware_model->get_queue();
		if($sub_malwares > 0){
			$this->load->library('commercial');
			foreach ($sub_malwares as $malware){
				$this->commercial->initialize(array('filename' => $malware->filename));
				$response = $this->commercial->poll($malware->filename);
				if($response){
					$this->commercial->save_report_xml($response);
					
					if($this->malware_model->save_commercial_report($malware->filename, $response)){
						$this->malware_model->update_status($malware->filename, self::STATUS_DONE );
						$this->malware_model->delete_queue($malware->filename);
					}
				}

			}
		}
		
	}

}
?> 