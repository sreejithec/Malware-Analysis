<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');
/**
 * Malware
 * 
 * Controller that handles all malware related operations like, saving the malware send by HomeyPot, submit them for analysis, poll for results,
 * save the reports etc.
 * 
 * 
 * 
 */
class Malware extends QCERT_Controller {
	
	CONST STATUS_NEW 		= 'NEW';
	CONST STATUS_SUBMITTED	= 'SUBM';
	CONST STATUS_DONE 		= 'DONE';
	
	private $_save_path;
	private $_file_param_name;
	
	/**
	 * __construct
	 * 
	 *
	 */
	public function __construct(){
		parent::__construct();
		$this->load->model('malware_model');
		
		$this->status_text = array(
								self::STATUS_NEW => 'New',
								self::STATUS_SUBMITTED => 'Submitted',
								self::STATUS_DONE => 'Done'
							 );
		
		$this->_save_path 		= 'analysis/source/';
		$this->_file_param_name = 'upfile';
	}

	
	public function listing($page=1){
		$data['status_text'] = $this->status_text;
		$page = ($page) ? (int)$page : 1;
		
		$this->malware_model->start  = $this->malware_model->limit = NULL;
		$this->paginate(count($this->malware_model->getCollection()), base_url().'malware/listing');
		
		$this->malware_model->start  = ((int)$this->uri->segment(PAGE_SEGMENT)) ? $this->uri->segment(PAGE_SEGMENT) : 0;
		$this->malware_model->limit = PER_PAGE;
		
		$data['collection'] = $this->malware_model->getCollection($page);
		$this->render('malware/listing',$data);
	}


	public function caught(){
		$this->load->helper('file');
		$sender_email = $this->input->post('email');
		
		if(!empty($_FILES[$this->_file_param_name]['tmp_name'])){
			$filename = $_FILES[$this->_file_param_name]['name'];
			// Check for duplicate file
			if(!($this->malware_model->is_duplicate($filename))){
				// Upload the file
				if($this->malware_model->do_upload($filename, $this->_save_path)){
					// Save the file data in database
					$ins = array('filename'=>$filename,
								 'sender_email' => $sender_email,
								 'size' => $_FILES[$this->_file_param_name]['size'],
								 'received_date' => mktime(),
								 'm_count' => 1,
								 'dionaea_status' => self::STATUS_NEW ,
								 'quickwine_status' => self::STATUS_NEW,
							);
					$this->malware_model->insert($ins);
				}
			}
			else{
				// We have a duplicate. Just increment the m_count column by one.
				$this->malware_model->increment_m_count($filename);
				
			}
			
		}
	}
	
	public function form(){
		echo '<form method="POST" enctype="multipart/form-data" action="http://localhost/manalysisv2/malware/caught"><input type="text" name="email" /><input type="file" name="upfile" /> <input type="submit" name="go" value="GO" />';
		
		
	}
	


}
?>