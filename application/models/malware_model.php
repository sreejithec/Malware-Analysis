<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Malware_model extends CI_Model {
	#private $_malware_table = 'malware_file';
	private $_table;
	private $_queue_table;
	
	public $start;
	public $limit;
	
	private $_log_path;
	protected $_date_fmt	= 'Y-m-d H:i:s';
	
	public function __construct(){
		$this->_table = 'tbl_malware';
		$this->_queue_table = 'tbl_queue';
		
		$this->start = 0;
		$this->limit = 5;
		
		$config =& get_config();
		$this->_log_path = ($config['log_path'] != '') ? $config['log_path'] : APPPATH.'logs/';
	}
	
	public function getCollection(){
		$sql = 'SELECT * FROM '.$this->_table.' WHERE 1 ORDER BY received_date DESC';
		if( isset($this->start) && isset($this->limit)){
			$sql .= ' LIMIT '.$this->start.', '.$this->limit;
		}
		
		$result = $this->db->query($sql);
		if($result->num_rows() > 0){
			foreach($result->result() as $row):
                $data[] = $row;
            endforeach;
            return $data;
		}
		return FALSE;
	}
	
	public function getSearchResults($k = NULL){
		if(!$k){
			return $this->getCollection();
		}else{
			$sql = 'SELECT * FROM '.$this->_table.' WHERE (
															(filename LIKE "%'.$this->db->escape_like_str($k).'%")
															 OR (sender_email LIKE "%'.$this->db->escape_like_str($k).'%")
															)';
			if( isset($this->start) && isset($this->limit)){
				$sql .= ' LIMIT '.$this->start.', '.$this->limit;
			}
			
			$result = $this->db->query($sql, $k);
			if($result->num_rows() > 0){
				foreach($result->result() as $row){
					$data[] = $row;
				};
				return $data;
			}
		}
		return FALSE;
	}
	
	public function getByFileName ($filename){
		$this->db->where('filename',$file_name);
		$result = $this->db->get($this->_table);
		if($result->num_rows() > 0){
            return $result->row();
		}
		return FALSE;
	}
	
	public function do_upload($file_name, $path)	{
		$config['file_name'] = $file_name;
		$config['upload_path'] = $path;
		$config['allowed_types'] = '*';

		$this->load->library('upload', $config);
		
		return ($this->upload->do_upload("upfile") == TRUE);
	}
	
	public function is_duplicate($file_name){
		$this->db->where('filename',$file_name);
		return $this->db->count_all_results($this->_table);
	}


	public function insert($ins){
		if(!empty($ins)){
			$this->db->insert($this->_table,$ins);
		}
	}

	public function increment_m_count($filename){
		$this->db->set('m_count', 'm_count+1', FALSE);
		$this->db->where('filename',$filename);
		$this->db->update($this->_table);
	}
	
	public function save_response($sandbox, $filename, $response='', $status="SUBM"){
		$this->db->set($sandbox.'_submit_response', $response);
		$this->db->set($sandbox.'_status', $status);
		$this->db->where('filename',$filename);
		$this->db->update($this->_table);
	}
	
	public function update_status($filename, $status, $sandbox='commercial'){
		$this->db->set($sandbox.'_status', $status);
		$this->db->where('filename',$filename);
		$this->db->update($this->_table);
	}
	
	public function add_queue($filename){
		return $this->db->insert($this->_queue_table, array('filename' => $filename));
	}
	
	public function delete_queue($filename){
		return $this->db->delete($this->_queue_table, array('filename'=>$filename));
	}
	
	public function get_queue(){
		$result = $this->db->get($this->_queue_table);
		if($result->num_rows() > 0){
			foreach($result->result() as $row):
				$data[] = $row;
            endforeach;
            return $data;
		}
		return FALSE;
	}
	
	public function save_commercial_report($filename, $report=''){
		if($report){
			$this->db->set('commercial_analysis_report', $report);
			$this->db->where('filename', $filename);
			return $this->db->update($this->_table);
		}
	}
	
	public function get_commercial_report($filename){
		$this->db->select('commercial_analysis_report');
		$result = $this->db->get_where($this->_table, array('filename'=>$filename));
		if($result->num_rows() > 0){
            return $result->row();
		}
		return FALSE;
	}
	
	
	public function write_log($level = 'error', $msg, $php_error = FALSE)
	{

		$filepath = $this->_log_path.'log-'.date('Y-m-d').EXT;
		$message  = '';

		if ( ! file_exists($filepath))
		{
			$message .= "<"."?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed'); ?".">\n\n";
		}

		if ( ! $fp = @fopen($filepath, FOPEN_WRITE_CREATE))
		{
			return FALSE;
		}

		$message .= $level.' '.(($level == 'INFO') ? ' -' : '-').' '.date($this->_date_fmt). ' --> '.$msg."\n";

		flock($fp, LOCK_EX);
		fwrite($fp, $message);
		flock($fp, LOCK_UN);
		fclose($fp);

		@chmod($filepath, FILE_WRITE_MODE);
		return TRUE;
	}

	





}
?>