<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Zerowine {
	
	public $md5;
	
	private $_cli_path;
	private $_server_url;
	private $_report_save_path;

	public function __construct($config){
		if(!empty($config)){
			$this->initialize($config);
		}
		$this->_cli_path		 = APPPATH.'third_party/zerowine/';
		$this->_server_url		 = 'http://192.168.1.185:8000';
		$this->_report_save_path = 'analysis/reports/zerowine/';
	}
	
	public function initialize($config){
		if(!array_key_exists('md5', $config)){
			trigger_error('Please specify the name of the malware file', E_USER_NOTICE);
			exit;
		}
		$this->md5 = $config['md5'];
	}
	
	public function analysis_submit($file){
		$command = $response = NULL;
		if(is_file($file)){
			$offset = '../../../';
			chdir($this->_cli_path);
			try{
				// Check whether server is alive
				$command = './xmlrpc_tester.py';
				$response = shell_exec($command);
				if(preg_match('/\[ALIVE\]/', $response) === 1){
					$command = $response = '';
					$this->md5 = basename($file);
					// Create the directory
					$report_save_folder = $this->_report_save_path.'/'.$this->md5;
					@mkdir($offset.$report_save_folder, DIR_READ_MODE);
					$command = './xmlrpc_client_extract.py '.$this->_server_url.' '.$offset.$file.' '.$offset.$report_save_folder;
					$response = shell_exec(escapeshellcmd($command));
					chdir($offset);
					if(preg_match('/No\sserver\savailable/', $response)){
						$response = NULL;
					}
				}else{
					$response = NULL;
				}
			}catch (Exception $e){
				chdir(BASEPATH);
			}
		}
		
		return $response;
	}
	
	public function get_file_tree($current = ''){
		if(empty($current) && !empty($this->md5)){
			$current = $this->_report_save_path.$this->md5.'/';
		}

		if( file_exists($current) ) {
			$files = scandir($current);
			natcasesort($files);
			$str = '';
			if( count($files) > 2 ) { /* The 2 accounts for . and .. */
				$str = $str . "<ul class=\"jqueryFileTree\" style=\"display: none;\">";
				// All dirs
				foreach( $files as $file ) {
					if( file_exists($current . $file) && $file != '.' && $file != '..' && is_dir($current . $file) ) {
						$str = $str . "<li class=\"directory collapsed\"><a href=\"#\" rel=\"" . htmlentities($current . $file) . "/\">" . htmlentities($file) . "</a></li>";
					}
				}
				
				// All files
				foreach( $files as $file ) {
					if( file_exists($current . $file) && $file != '.' && $file != '..' && !is_dir($current . $file) ) {
						$ext = preg_replace('/^.*\./', '', $file);
						$str = $str . "<li class=\"file ext_$ext\"><a href=\"#\" rel=\"" . htmlentities($current . $file) . "\">" . htmlentities($file) . "</a></li>";
					}
				}
				$str = $str . "</ul>";
			}
			return $str;
		}
		
		return FALSE;

	}
	
	
}


?>