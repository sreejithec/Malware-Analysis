<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Commercial {

	public $filename;
	public $md5;
	
	private $_server_url;
	private $_poll_url;
	private $_report_save_path;
	private $_submit_url;
	private $_submit_file_fieldname;
	private $_malware_save_path;
	
	protected $_xml;
	

	public function __construct($config=array()){
		if(!empty($config)){
			$this->initialize($config);
		}
		
		$this->_server_url			   = 'http://213.130.111.53';
		$this->_poll_url 			   = $this->_server_url.'/websvc/analyses/100000/csv/epoch/1262293200';
		$this->_submit_file_fieldname  = 'upfile';
		$this->_submit_url 			   = $this->_server_url.'/websvc/submit/csv/';
		
	}

	
	public function initialize($config){
		if(!array_key_exists('md5', $config)){
			trigger_error('Please specify the name of the malware file', E_USER_NOTICE);
			exit;
		}
		$this->md5 = $config['md5'];
		$this->_report_save_path = 'analysis/reports/commercial/';
	}
		
	public function get_server_url(){
		return $this->_server_url;
	}
	
	public function analysis_submit($file, $params=array()){
		$command = '';
		$response = NULL;
		if(is_file($file)){
			//$response = shell_exec('curl -X POST -F "upfile=@'.$file.'" -F "email='.$email.'" '.$url);	
			$command = 'curl -X POST -F "'.$this->_submit_file_fieldname.'=@'.$file;
			if(!empty($params)){
				foreach ($params as $key => $val){
					$command = $command . '" -F "'.$key.'='.$val.'" ';
				}
			}
			$command = $command.' '.$this->_submit_url;
			$response = shell_exec(escapeshellcmd($command));
		}
		return $response;
	}
	

	public function poll($md5){
		return shell_exec('curl --silent '.$this->_poll_url.' | grep \''.$md5.'\'');
	}


	public function save_report_xml($report_str){
		//104,783c50f221c339f244ac68b38fcd30af,/data/0-10000/104/104.xml,/data/0-10000/104/104.cab,/data/0-10000/104/104.pcap,1272375738,1010000101111010110101
		if($report_str){
			list($id,$filename, $filemd5,$xml,$cab,$pcap,$date_created,$dbt) = explode(',', $report_str);
			if($xml){
				$xml_content = file_get_contents($this->_server_url.$xml);
				
				// save the file under analysis/reports/commercial folder
				$fp = fopen($this->_report_save_path.'/'.$filemd5.'.xml', 'w');
				fwrite($fp, $xml_content);
				fclose($fp);
				return TRUE;
			}
		}
		return FALSE;
	}

	public function load_xml(){
		if(file_exists($this->_report_save_path.$this->md5.'.xml')){
			$xml = file_get_contents($this->_report_save_path.$this->md5.'.xml');
			$this->_xml = simplexml_load_string($xml);
			return TRUE;
		}else{
			return FALSE;
		}
	}
	
	public function get_xml(){
		return (isset($this->_xml)) ? $this->_xml : NULL;
	}
	
	
	public function get_attributes(SimpleXMLElement $node){
		$attributes = array();
		foreach($node->attributes() as $attr => $val){
			$val = (array)$val;
			$attributes[$attr] = $val[0];
		}
		return $attributes;
	}
	
	public function get_processes(){
		$data = array();
		if($this->_xml){
			$processes_node = $this->_xml->xpath('/analysis/processes');
			
			foreach ($processes_node[0]->children() as $process){
				//Store attributes
				$attributes = $this->get_attributes($process);
				$pIndex = $attributes['index'];
				$data[$pIndex] = $attributes;
			}

		}
		return $data;
	}
	
	public function get_outgoing_ips(){
		$d = array();
		if($this->_xml){
			$conns = $this->_xml->xpath('//connections_outgoing/connection');
			if($conns){
				foreach ($conns as $conn){
					$attr = array();
					$attr = $this->get_attributes($conn);
					if(isset($attr['remoteaddr'])){
						$d[] = $attr['remoteaddr'];
					}
				}
			}
		}
		return $d;
	}


}

?>