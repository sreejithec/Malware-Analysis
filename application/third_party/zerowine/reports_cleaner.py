#!/usr/bin/env python

import os
import sys

def passFilter(line):
    if line.find(r'malware:Call to CreateFileW(L"C:\\windows\\win.ini", GENERIC_READ FILE_SHARE_READ FILE_SHARE_WRITE FILE_SHARE_DELETE , creation 3 attributes 0x80)') > -1:
        return False
    elif line.find(r'C:\\windows\\system32\\winedevice.exe MountMgr') > -1:
        return False
    elif line.find('L"__WINE_FONT_MUTEX__"') > -1:
        return False
    elif line.startswith('Error adding process ptrace(cmd='):
        return False
    
    return True

def main(directory):
    for filename in os.listdir(directory):
        if not filename.endswith("rpt"):
            continue
        #print "Fixing report %s ..." % filename
        ret = ""
        
        done = False
        lines = 0
        prev_line = None
        repeated = 0
        
        for line in file(directory + os.sep + filename, "r"):
            
            if line.find('malware:Starting process L"Z:') > -1 and not done:
                done = True
            elif not done:
                continue
            
            if line == prev_line and prev_line is not None:
                repeated += 1
                continue
            else:
                repeated = 0
                prev_line = line
            
            lines += 1
            if passFilter(line):
                if repeated > 0:
                    ret += "Last line repeated %d time(s)%s" % (repeated, os.linesep)
                ret += line
        
        if repeated > 0:
            ret += "Last line repeated %d time(s)%s" % (repeated, os.linesep)
        
        if lines > 2:
            f = file(directory + os.sep + filename, "w")
            f.write(ret)
            f.close()
        else:
            print "Empty report for %s" % filename

def usage():
    print "Usage:", sys.argv[0], "<directory>"

if __name__ == "__main__":
    if len(sys.argv) != 2:
        usage()
    else:
        main(sys.argv[1])

