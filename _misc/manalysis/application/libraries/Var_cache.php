<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');

/**
 * Var_cache Class
 */
class Var_cache {
    var $vars = array();
    var $table_name = '';
    
    function Var_cache() {
        $this->initialize();
    }
    
    function initialize() {
        $CI =& get_instance();
        
        // Load the table name
        $CI->config->load('var_cache', TRUE);
        
        $config = $CI->config->item('var_cache');
        
        if (!isset($config['var_cache_table_name']))
            show_error("To Use the Var_cache library, the var_cache config file is require");
        
        $table_name = $config['var_cache_table_name'];
        
        $this->table_name = $table_name;
        
        
        // If the table does not exist, make it
        if (!$CI->db->table_exists($this->table_name)) {
            $CI->load->dbforge();
            
            $fields = array(
                'name'=>array(
                    'type'=>'VARCHAR',
                     'constraint'=>255
                 ),
                 'value'=>array(
                    'type'=>'TEXT'
                     //'constraint'=>255
                 ),
                 'expiration'=>array(
                     'type'=>'DATETIME'
                 )
             );
            
            $CI->dbforge->add_field('id');
            $CI->dbforge->add_field($fields);
            
            $CI->dbforge->create_table($this->table_name,TRUE);
        }
        
        
        // Load variables that have not expired into $this->vars
        $query = $CI->db->get_where($this->table_name,array('expiration >='=>date('Y-m-d H:i:s')));
        
        foreach($query->result() as $var) {
            $this->vars[$var->name] = $var->value;
        }
    }
    
    function get_var($name) {
    	
        return $this->element($name,$this->vars);
    }
    
    function element ($key, $stack){
    	if(array_key_exists($key, $stack)){
    		return $stack[$key];
    	}
    	return FALSE;
    }
    
    // $expiration_time is in minutes
    function set_var($name,$value,$expiration_time=1440) {
        $CI =& get_instance();
        
        $data = array(
            'name'=>$name,
            'value'=>$value,
            'expiration'=>date('Y-m-d H:i:s',time()+$expiration_time*60)
        );
        
        if ($CI->db->get_where($this->table_name,array('name'=>$name))->num_rows())
            $CI->db->update($this->table_name,$data,array('name'=>$name));
        else
            $CI->db->insert($this->table_name,$data);
    }
}  