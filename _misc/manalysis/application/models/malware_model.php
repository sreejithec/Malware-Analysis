<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Malware_model extends CI_Model {
	#private $_malware_table = 'malware_file';

	public $start;
	public $limit;
	
	private $_log_path;
	protected $_date_fmt	= 'Y-m-d H:i:s';
	
	public function __construct(){
		$this->_table = 'malware_file';
		$this->_count_table = 'malware_file_count';
		
		$this->start = 0;
		$this->limit = 5;
		
		$config =& get_config();
		$this->_log_path = ($config['log_path'] != '') ? $config['log_path'] : APPPATH.'logs/';
	}
	
	public function getCollection(){
		$sql = 'SELECT * FROM '.$this->_table.' WHERE 1 ORDER BY received_date DESC';
		if( isset($this->start) && isset($this->limit)){
			$sql .= ' LIMIT '.$this->start.', '.$this->limit;
		}
		
		$result = $this->db->query($sql);
		if($result->num_rows() > 0){
			foreach($result->result() as $row):
                $data[] = $row;
            endforeach;
            return $data;
		}
		return FALSE;
	}
	
	public function getSearchResults($k = NULL){
		if(!$k){
			return $this->getCollection();
		}else{
			$sql = 'SELECT * FROM '.$this->_table.' WHERE (
															(file_name LIKE "%'.$this->db->escape_like_str($k).'%")
															 OR (email_sender LIKE "%'.$this->db->escape_like_str($k).'%")
															)';
			if( isset($this->start) && isset($this->limit)){
				$sql .= ' LIMIT '.$this->start.', '.$this->limit;
			}
			
			$result = $this->db->query($sql, $k);
			if($result->num_rows() > 0){
				foreach($result->result() as $row){
					$data[] = $row;
				};
				return $data;
			}
		}
		return FALSE;
	}
	
	public function getByFileName ($file_name){
		$this->db->where('file_name',$file_name);
		$result = $this->db->get($this->_table);
		if($result->num_rows() > 0){
            return $result->row();
		}
		return FALSE;
	}
	

	public function getByAnalysisStatus ($status){
		$this->db->where('is_analyzed',$status);
		$result = $this->db->get($this->_table);
		if($result->num_rows() > 0){
			foreach($result->result() as $row):
                $data[] = $row;
            endforeach;
            return $data;
		}
		return FALSE;
	}
	
	public function updateAnalysisStatusByFileName($filename, $status){
		$this->db->set('is_analyzed', $status, FALSE);
		$this->db->where('file_name',$filename);
		$this->db->update($this->_table);
	}

	public function do_upload($file_name, $path)	{
		$config['file_name'] = $file_name;
		$config['upload_path'] = $path;
		$config['allowed_types'] = '*';

		$this->load->library('upload', $config);
		
		return ($this->upload->do_upload("upfile") == TRUE);
	}
	
	public function is_duplicate($file_name){
		$this->db->where('file_name',$file_name);
		return $this->db->count_all_results($this->_table);
	}


	public function save_file($ins){
		$this->db->insert($this->_table,$ins);
	}

	public function increment_malware_count($file_name){
		$this->db->set('m_count', 'm_count+1', FALSE);
		$this->db->where('file_name',$file_name);
		$this->db->update($this->_table);
	}
	
	
	public function write_log($level = 'error', $msg, $php_error = FALSE)
	{print ($msg);

		$filepath = $this->_log_path.'log-'.date('Y-m-d').EXT;
		$message  = '';

		if ( ! file_exists($filepath))
		{
			$message .= "<"."?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed'); ?".">\n\n";
		}

		if ( ! $fp = @fopen($filepath, FOPEN_WRITE_CREATE))
		{
			return FALSE;
		}

		$message .= $level.' '.(($level == 'INFO') ? ' -' : '-').' '.date($this->_date_fmt). ' --> '.$msg."\n";

		flock($fp, LOCK_EX);
		fwrite($fp, $message);
		flock($fp, LOCK_UN);
		fclose($fp);

		@chmod($filepath, FILE_WRITE_MODE);
		return TRUE;
	}







}
?>